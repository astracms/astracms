---
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";
import Container from "@/components/Container.astro";
import Prose from "@/components/Prose.astro";
import Layout from "@/layouts/Layout.astro";
import { SITE } from "@/lib/constants";
import { calculateReadTime } from "@/lib/utils";

export const prerender = true;

export async function getStaticPaths() {
  const changelogEntries = await getCollection("changelog");
  return changelogEntries.map((entry) => ({
    params: { slug: entry.data.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;

const formattedDate = new Date(entry.data.publishedAt).toLocaleDateString(
  "en-US",
  {
    year: "numeric",
    month: "long",
    day: "numeric",
  }
);

const { Content } = await render(entry);

const readTime = calculateReadTime(entry.body as string);
---

<Layout
  title={`${entry.data.title} - ${SITE.TITLE}`}
  description={entry.data.description}
  image={entry.data.coverImage}
>
  <section
    class="min-h-[calc(100vh-88px)] sm:min-h-[calc(100vh-103px)] lg:min-h-[calc(100vh-120px)] border-y border-dashed"
  >
    <div
      class="lg:border-x border-dashed md:w-[calc(100%-140px)] mx-auto h-full"
    >
      <Container class="md:py-20 py-10 md:pb-24">
        <section class="max-w-3xl mx-auto mb-6 md:mb-10 space-y-6">
          <div class="flex flex-col gap-4 max-w-2xl mx-auto">
            <h1 class="text-3xl lg:text-4xl text-balance leading-[1.2] mb-2">
              {entry.data.title}
            </h1>
            <div class="flex items-center gap-6 justify-btween">
              <div class="flex items-center gap-2">
                <span class="h-4 w-0.5 bg-gray-300 shrink-0"></span>
                <time
                  datetime={entry.data.publishedAt.toISOString()}
                  class="text-muted-foreground text-sm sm:text-base"
                >
                  {formattedDate}
                </time>
              </div>
              <div class="flex items-center gap-2">
                <span class="h-4 w-0.5 bg-gray-300 shrink-0"></span>
                <p class="text-muted-foreground text-sm sm:text-base">
                  {readTime}minute read
                </p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              {entry.data?.authors?.map((author) => (
                  <div class="flex items-center gap-2">
                    {author.image ? (
                      <Image
                        src={author.image}
                        alt={author.name}
                        class="size-7 rounded-full"
                        inferSize
                      />
                    ) : (
                      <span class="h-4 w-0.5 bg-gray-300 shrink-0" />
                    )}
                    <p class="text-muted-foreground text-sm sm:text-base">
                      {author.name}
                    </p>
                  </div>
                ))}
            </div>
          </div>
        </section>
        <div>
          {entry.data.coverImage && (
              <Image
                src={entry.data.coverImage}
                alt={entry.data.title}
                class="w-full max-w-3xl mx-auto mb-8"
                inferSize
              />
            )}
        </div>
        <Prose>
          <Content />
        </Prose>
      </Container>
    </div>
  </section>
</Layout>
